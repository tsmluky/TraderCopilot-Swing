name: TraderCopilot CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx ruff
        
    - name: Link Root DB
      run: |
        # Simulate local dev structure where db is in root
        touch ../dev_local.db

    - name: Lint with Ruff
      run: |
        ruff check .

    - name: Test with pytest
      run: |
        export DATABASE_URL=sqlite:///../dev_local.db
        export SECRET_KEY=testing_secret
        export PYTHONPATH=$PYTHONPATH:.
        pytest tests/test_auth_flow_v2.py

  web-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web

    steps:
    - uses: actions/checkout@v3
    
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 10

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: './web/pnpm-lock.yaml'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build
      run: pnpm run build
